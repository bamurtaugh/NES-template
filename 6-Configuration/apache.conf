# NES Demo: Apache Configuration - Security and Performance Optimization
# Try making the following edits to see Next Edit Suggestions in action:

# Main server configuration
ServerRoot "/etc/apache2"
Listen 80
Listen 443 ssl

# NES Scenario 1: Update ServerTokens for security
# When you change ServerTokens to "Prod",
# NES should suggest updating ServerSignature to Off
# and adding other security-related directives
ServerTokens Full
ServerSignature On

# Load modules
LoadModule rewrite_module modules/mod_rewrite.so
LoadModule ssl_module modules/mod_ssl.so
LoadModule headers_module modules/mod_headers.so
LoadModule expires_module modules/mod_expires.so
LoadModule deflate_module modules/mod_deflate.so

# NES Scenario 2: Add security modules
# When you add LoadModule security2_module,
# NES should suggest adding mod_evasive and other security modules
# LoadModule security2_module modules/mod_security2.so

# Basic configuration
ServerName example.com
ServerAdmin admin@example.com
DocumentRoot "/var/www/html"

# Directory permissions
<Directory />
    Options FollowSymLinks
    AllowOverride None
    Require all denied
</Directory>

<Directory "/var/www/html">
    Options Indexes FollowSymLinks
    AllowOverride All
    Require all granted
    
    # NES Scenario 3: Add security options
    # When you change Options to -Indexes -FollowSymLinks,
    # NES should suggest additional security measures
    # and .htaccess configurations
</Directory>

# Logging configuration
ErrorLog logs/error.log
LogLevel warn

LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
LogFormat "%h %l %u %t \"%r\" %>s %b" common

# NES Scenario 4: Add custom log format
# When you add a custom LogFormat for API requests,
# NES should suggest appropriate field selections
# and log rotation configurations
CustomLog logs/access.log combined

# MIME types
TypesConfig conf/mime.types

# Security headers (basic)
Header always set X-Content-Type-Options nosniff
Header always set X-Frame-Options SAMEORIGIN
Header always set X-XSS-Protection "1; mode=block"

# NES Scenario 5: Add Content Security Policy
# When you add Header always set Content-Security-Policy,
# NES should suggest appropriate CSP directives based on
# the application type and existing headers
# Header always set Content-Security-Policy "default-src 'self'"

# SSL Configuration
SSLEngine on
SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256
SSLHonorCipherOrder off
SSLSessionTickets off

# Compression
<IfModule mod_deflate.c>
    # Compress HTML, CSS, JavaScript, Text, XML and fonts
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/vnd.ms-fontobject
    AddOutputFilterByType DEFLATE application/x-font
    AddOutputFilterByType DEFLATE application/x-font-opentype
    AddOutputFilterByType DEFLATE application/x-font-otf
    AddOutputFilterByType DEFLATE application/x-font-truetype
    AddOutputFilterByType DEFLATE application/x-font-ttf
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE font/opentype
    AddOutputFilterByType DEFLATE font/otf
    AddOutputFilterByType DEFLATE font/ttf
    AddOutputFilterByType DEFLATE image/svg+xml
    AddOutputFilterByType DEFLATE image/x-icon
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/xml
</IfModule>

# Cache control
<IfModule mod_expires.c>
    ExpiresActive on
    
    # Images
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/svg+xml "access plus 1 month"
    ExpiresByType image/x-icon "access plus 1 year"
    
    # CSS and JavaScript
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    
    # NES Scenario 6: Add font caching
    # When you add font ExpiresByType rules,
    # NES should suggest appropriate cache durations
    # and Cache-Control headers for fonts
</IfModule>

# Virtual Host for HTTP (redirect to HTTPS)
<VirtualHost *:80>
    ServerName example.com
    ServerAlias www.example.com
    DocumentRoot "/var/www/html"
    
    # NES Scenario 7: Add HTTPS redirect
    # When you add Redirect permanent / https://example.com/,
    # NES should suggest updating the HTTPS virtual host
    # and adding HSTS headers
    
    ErrorLog logs/error.log
    CustomLog logs/access.log combined
</VirtualHost>

# Virtual Host for HTTPS
<VirtualHost *:443>
    ServerName example.com
    ServerAlias www.example.com
    DocumentRoot "/var/www/html"
    
    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/example.com.crt
    SSLCertificateKeyFile /etc/ssl/private/example.com.key
    
    # HSTS Header
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    
    # API Proxy Configuration
    ProxyPreserveHost On
    ProxyRequests Off
    
    <Location "/api/">
        ProxyPass "http://localhost:3000/api/"
        ProxyPassReverse "http://localhost:3000/api/"
        
        # NES Scenario 8: Add proxy headers
        # When you add ProxyPassReverse headers,
        # NES should suggest adding X-Forwarded headers
        # and proper proxy configuration
        ProxySetEnv X-Forwarded-Proto https
        ProxySetEnv X-Forwarded-Port 443
    </Location>
    
    # Static file optimization
    <LocationMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg)$">
        # Add cache headers
        Header set Cache-Control "max-age=31536000, public"
    </LocationMatch>
    
    ErrorLog logs/ssl_error.log
    CustomLog logs/ssl_access.log combined
</VirtualHost>

# Security configurations
<IfModule mod_security2.c>
    # NES Scenario 9: Add ModSecurity rules
    # When you add SecRuleEngine On,
    # NES should suggest common rule sets
    # and appropriate security configurations
    SecRuleEngine DetectionOnly
    SecDataDir /tmp/modsecurity
</IfModule>